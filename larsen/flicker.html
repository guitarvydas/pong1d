<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Flicker</title>
    <link rel="stylesheet" href="style.css">
    <style>
      .bar { display: flex; }
      .led { width: 12px; height: 12px; background: lightgray; border-radius: 50%; }
      .on  { background: red; border-radius: 50%; width: 32px; height: 32px;}
    </style>
  </head>
  <body>
    <h1>Flicker</h1>
    <p>You should see a blinking "LED" under here...</p>
    <div id="led0"></div>
    
    <script>
      var MASTER = 0; // Master counter for ticks.

      // I/O as FIFO queues in dictionary.
      
      function outp(source, pin, value) {
	  for(var i = 0; i < wires.length; i += 1) {
	      if(source == wires[i][0] &&
		 pin == wires[i][1]) {
		  const key = `${wires[i][2]}:${wires[i][3]}`;
		  console.log (source, pin, key);
		  if(!queues[key]) { queues[key] = []; }
		  if(queues[key].length > 5) { queues[key] = []; } // Clear stale signals.
		  queues[key].push(value);
	      }
	  }
      }

      function inp(target, pin) {
	  const key = `${target}:${pin}`;
	  if(queues[key]) {
	      return queues[key].shift();
	  } else {
	      return null;
	  }
      }

      // Chips.
      
      function TICK(name) {
	  console.log (`TICK(${name})`);
	  // ( name --) Clock generator with 20% duty cycle.
	  
	  if(MASTER % 100 <= 20) {
	      console.log (`TICK A ${name}`);
	      outp(name, "OUT", true);
	  }
	  console.log (`TICK B ${name}`);
	  MASTER += 1;
      }

      function LED(name) {
	  console.log (`LED(${name})`);
	  // ( name --) Single LED display, updates div with id $name.
	  
	  const surface = document.getElementById(`${name}`);
	  var klass = "led";
	  if(surface) {
	      if(inp(name, "IN")) {
		  klass = "led on";
	      }
	      surface.innerHTML = `<div class="${klass}">&nbsp;</div>`;
	      console.log (`LED ${name} ${surface.innerHTML}`);
	  }
      }
      
      var queues = {};
      var chips = {
	  "tick": TICK,
	  "led0": LED
      };
      var wires = [
	  ["tick", "OUT", "led0", "IN"]
      ];

      function step() {
	  console.log (`STEP`);
	  // ( --) Walks through all chips and evals.
	  
	  Object.entries(chips).forEach((p) => {
	      p[1](p[0]); // Call chip with current name.
	  });
      }

      var countdown = 25;

      function tickloop() {
	  // ( --) Limits ticks to browser framerate so doesn't hang.

	  console.log (`countdown = ${countdown}`);
	  step();
	  console.log ('tick');
	  countdown -= 1;
	  if (countdown > 0) {
	      window.requestAnimationFrame(tickloop);
	  }
      }
      window.requestAnimationFrame(tickloop);
    </script>
  </body>
</html>
